prefix	    = @prefix@
exec_prefix = @exec_prefix@

bindir	    = @bindir@
mandir	    = @mandir@

CC	= @CC@
CFLAGS	= @CFLAGS@
DEFS	= @DEFS@
LIBS	= @LIBS@

INSTALL = @INSTALL@
RM	= rm -vf

MAIN	= wavemon.c
PURESRC	= $(filter-out $(MAIN),$(wildcard *.c))
OBJS	= $(PURESRC:.c=.o)

%.o: %.c %.h
	$(CC) $(CFLAGS) $(DEFS) -c -o $@ $<

wavemon: $(MAIN) $(OBJS)
	$(CC) $(CFLAGS) $(LIBS) $^ -o $@

$(MAIN): Makefile
Makefile: Makefile.in config.status
	./config.status
config.status: configure
	./config.status --recheck
configure: configure.in
	autoconf

tags: $(wildcard *[ch])
	ctags $^ > $@

.PHONY: install ipkg clean distclean uninstall
IPAQ_DOCS = AUTHORS COPYING Changelog Makefile README TODO wavemon.doc wavemonrc.doc

wavemon.doc: wavemon.1
	groff -Tascii -man $^ > $@
wavemonrc.doc: wavemonrc.5
	groff -Tascii -man $^ > $@

ipkg: wavemon $(IPAQ_DOCS)
	mkdir -p ipkg/usr/local/bin
	$(INSTALL) -c -m 755 wavemon ipkg/usr/local/bin
	mkdir -p ipkg/usr/doc/wavemon
	for f in $(IPAQ_DOCS); do $(INSTALL) -c -m 644 $$f ipkg/usr/doc/wavemon ; done
	mkdir -p ipkg/usr/lib/menu
	echo '?package(wavemon): needs="text" section="Utilities" title="wavemon" command="wavemon"' > ipkg/usr/lib/menu/wavemon
	mkdir -p  ipkg/CONTROL
	echo "Package: wavemon" > ipkg/CONTROL/control
	echo "Version: @WAVEMON_VERSION@" >> ipkg/CONTROL/control
	echo "Architecture: arm" >> ipkg/CONTROL/control
	echo "Maintainer: dave w capella <dave.capella@cornell.edu>" >> ipkg/CONTROL/control
	echo "Description: Wireless network monitoring tool" >> ipkg/CONTROL/control
	echo "Priority: optional" >> ipkg/CONTROL/control
	echo "Section: extras" >> ipkg/CONTROL/control
	ipkg-build ipkg

install: wavemon wavemon.1 wavemonrc.5
	$(INSTALL) -m 755 wavemon $(bindir)
	$(INSTALL) -m 644 wavemon.1 $(mandir)/man1
	$(INSTALL) -m 644 wavemonrc.5 $(mandir)/man5

uninstall:
	@$(RM) $(bindir)/wavemon
	@$(RM) $(mandir)/man1/wavemon.1
	@$(RM) $(mandir)/man5/wavemonrc.5

clean:
	@$(RM) *.o *.doc wavemon tags
	@$(RM) -r ipkg

distclean: uninstall clean
	@$(RM) config.status config.log config.cache Makefile
